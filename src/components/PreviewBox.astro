---
// Simple preview box used on homepage
// Props: title, href, image (src), alt, url
const { title: propTitle, href: propHref, image: propImage, alt: propAlt, url: propUrl } = Astro.props;

let title = propTitle;
let href = propHref;
let image = propImage;
let alt = propAlt;
let desc = undefined;

// At build-time, if a `url` is provided, fetch the page and try to extract Open Graph / meta tags.
if (propUrl) {
  try {
    // Use global fetch (Node 18+ / Astro server environment)
    const res = await fetch(propUrl, { redirect: 'follow' });
    const text = await res.text();
    // quick parse for common meta tags
    const ogTitle = text.match(/<meta[^>]*property=["']og:title["'][^>]*content=["']([^"']+)["'][^>]*>/i)?.[1];
    const ogDesc = text.match(/<meta[^>]*property=["']og:description["'][^>]*content=["']([^"']+)["'][^>]*>/i)?.[1];
    const ogImage = text.match(/<meta[^>]*property=["']og:image["'][^>]*content=["']([^"']+)["'][^>]*>/i)?.[1];
    const metaDesc = text.match(/<meta[^>]*name=["']description["'][^>]*content=["']([^"']+)["'][^>]*>/i)?.[1];
    const titleTag = text.match(/<title[^>]*>([^<]+)<\/title>/i)?.[1];

    title = title || ogTitle || titleTag || title;
    desc = ogDesc || metaDesc || desc;
    image = image || ogImage || image;
    href = href || propUrl;
    alt = alt || title;
  } catch (e) {
    // fail silently at build-time
    // console.warn('PreviewBox fetch failed', e);
  }
}
---

<a class="block rounded-xl overflow-hidden" href={href || '#'}>
  <div class="flex flex-col md:flex-row">
    {image ? (
      <div class="md:w-40 flex-shrink-0">
        <img src={image} alt={alt || title} class="h-40 object-cover" />
      </div>
    ) : null}

    <div class="p-4 flex-1">
      <h3 class="font-bold text-xl">{title}</h3>
      <div class="mt-2 text-base text-neutral-700">
        {desc ? <p set:html={desc}></p> : <slot />}
      </div>
    </div>
  </div>
</a>
